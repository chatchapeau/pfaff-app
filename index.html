<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PFAFF 1222E - Control Panel</title>
    <!-- Chargement des styles et bibliothèques (React, Lucide, Tailwind) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0c0a09;
            color: #f5f5f4;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        /* Curseur personnalisé pour écran tactile */
        input[type="range"] {
            -webkit-appearance: none;
            background: #292524;
            height: 8px;
            border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 32px;
            width: 32px;
            border-radius: 50%;
            background: #e30613;
            border: 4px solid #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const App = () => {
            const [speed, setSpeed] = useState(0);
            const [isConnected, setIsConnected] = useState(false);
            const [status, setStatus] = useState("EN ATTENTE");
            const [pmhDuration, setPmhDuration] = useState(450);
            const [isSaving, setIsSaving] = useState(false);
            const socketRef = useRef(null);

            // Initialisation des icônes Lucide après rendu
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            });

            // Connexion WebSocket vers l'ESP32
            useEffect(() => {
                const connect = () => {
                    // Utilisation du nom mDNS défini dans le firmware v15.5
                    const ws = new WebSocket('ws://pfaff-1222e.local:81');
                    socketRef.current = ws;

                    ws.onopen = () => {
                        setIsConnected(true);
                        setStatus("MACHINE CONNECTÉE");
                    };

                    ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.status) setStatus(data.status);
                            if (data.storedPmh) setPmhDuration(data.storedPmh);
                        } catch (e) { console.error("Erreur JSON", e); }
                    };

                    ws.onclose = () => {
                        setIsConnected(false);
                        setStatus("HORS LIGNE");
                        // Tentative de reconnexion automatique toutes les 3s
                        setTimeout(connect, 3000);
                    };
                };

                connect();
                return () => { if (socketRef.current) socketRef.current.close(); };
            }, []);

            // Fonction d'envoi de commande via le socket actif
            const send = (data) => {
                if (socketRef.current && socketRef.current.readyState === WebSocket.OPEN) {
                    socketRef.current.send(JSON.stringify(data));
                }
            };

            const triggerPmh = () => send({ "VIRTUAL_PMH": pmhDuration });
            
            const savePmh = () => {
                setIsSaving(true);
                send({ "SAVE_PMH": pmhDuration });
                setTimeout(() => setIsSaving(false), 1000);
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    {/* Header PFAFF avec indicateur de statut */}
                    <div className="w-full max-w-md bg-stone-900 border border-stone-800 p-4 rounded-3xl flex justify-between items-center shadow-xl mb-6">
                        <div className="flex items-center gap-3">
                            <div className="bg-[#e30613] text-white px-3 py-1 rounded-lg font-black italic text-xl shadow-lg shadow-red-600/20">PFAFF</div>
                            <div className="text-[10px] font-bold text-stone-500 tracking-widest uppercase">v1.1 Stable</div>
                        </div>
                        <div className="flex items-center gap-2">
                            <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`} />
                            <span className="text-[10px] font-black uppercase text-stone-400">
                                {isConnected ? 'Link Active' : 'Offline'}
                            </span>
                        </div>
                    </div>

                    <div className="w-full max-w-md space-y-6">
                        {/* Contrôle de Vitesse Principale avec Jauge Circulaire */}
                        <div className="bg-stone-900 rounded-[2.5rem] p-8 border border-stone-800 shadow-2xl flex flex-col items-center">
                            <div className="relative mb-8">
                                <svg className="w-56 h-56 -rotate-90">
                                    <circle cx="112" cy="112" r="100" stroke="currentColor" strokeWidth="4" fill="transparent" className="text-stone-800" />
                                    <circle 
                                        cx="112" cy="112" r="100" stroke="currentColor" strokeWidth="12" fill="transparent"
                                        strokeDasharray={2 * Math.PI * 100}
                                        strokeDashoffset={2 * Math.PI * 100 * (1 - speed / 100)}
                                        className="text-[#e30613] transition-all duration-300 ease-out"
                                        strokeLinecap="round"
                                    />
                                </svg>
                                <div className="absolute inset-0 flex flex-col items-center justify-center">
                                    <span className="text-8xl font-black tabular-nums">{speed}</span>
                                    <span className="text-stone-500 text-xs font-bold uppercase tracking-[0.2em]">Vitesse %</span>
                                </div>
                            </div>
                            <input 
                                type="range" min="0" max="100" value={speed} 
                                onChange={(e) => {
                                    const val = parseInt(e.target.value);
                                    setSpeed(val);
                                    send({ "SET_SPEED": val });
                                }}
                                className="w-full"
                            />
                        </div>

                        {/* Module de Calibrage PMH Virtuel (Arrêt Calculé) */}
                        <div className="bg-stone-900 rounded-[2rem] border border-stone-800 p-6 shadow-inner relative overflow-hidden">
                            <div className="flex justify-between items-center mb-6">
                                <div className="flex items-center gap-2 text-[#e30613]">
                                    <i data-lucide="timer" className="w-4 h-4"></i>
                                    <h3 className="text-[10px] font-black uppercase tracking-widest">Calculateur d'arrêt PMH</h3>
                                </div>
                                <div className="flex items-center gap-3">
                                    <span className="font-mono text-sm text-stone-400">{pmhDuration}ms</span>
                                    <button 
                                        onClick={savePmh} 
                                        className={`p-2 rounded-lg transition-all ${isSaving ? 'bg-emerald-600 text-white' : 'bg-stone-800 text-stone-400 hover:text-white'}`}
                                    >
                                        <i data-lucide="save" className="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <input 
                                type="range" min="100" max="1500" step="5" value={pmhDuration} 
                                onChange={(e) => setPmhDuration(parseInt(e.target.value))}
                                className="w-full mb-8"
                            />

                            <button 
                                onClick={triggerPmh}
                                className="w-full bg-stone-100 text-stone-950 rounded-2xl p-8 flex flex-col items-center gap-3 active:scale-95 transition-all shadow-xl hover:bg-white group"
                            >
                                <i data-lucide="chevron-up" className="w-10 h-10 text-[#e30613]"></i>
                                <span className="font-black text-2xl uppercase italic tracking-tight">Impulsion PMH</span>
                            </button>
                        </div>

                        {/* Barre de Télémétrie et Diagnostic */}
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-stone-900/50 p-4 rounded-2xl border border-stone-800 flex justify-between items-center text-center">
                                <i data-lucide="activity" className="w-5 h-5 text-blue-500"></i>
                                <span className="font-bold text-[10px] uppercase text-stone-300 truncate text-right flex-1 ml-2">{status}</span>
                            </div>
                            <div className="bg-stone-900/50 p-4 rounded-2xl border border-stone-800 flex justify-between items-center text-center">
                                <i data-lucide="shield-check" className="w-5 h-5 text-emerald-500"></i>
                                <span className="font-bold text-[10px] text-emerald-500 uppercase tracking-widest">v15.5 Stable</span>
                            </div>
                        </div>
                    </div>

                    <footer className="mt-12 opacity-20 text-[9px] uppercase tracking-[0.4em] font-bold text-center">
                        Pfaff 1222E Digital Control Panel<br/>Projet de Modernisation Denis Lebel
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>